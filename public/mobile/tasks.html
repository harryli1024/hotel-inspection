<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>我的任务 - 酒店巡检</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/mobile.css">
  <style>
    .area-group { margin-bottom: 12px; }
    .area-header {
      background: var(--bg-white);
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .area-header .floor-info {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-light);
    }
    .cp-group { background: var(--bg-white); }
    .cp-header {
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    .cp-header:active { background: #f5f5f5; }
    .cp-header .cp-name {
      font-size: 14px;
      font-weight: 500;
    }
    .cp-header .cp-progress {
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cp-header .cp-progress .progress-mini {
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .cp-header .cp-progress .progress-mini-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 2px;
      transition: width 0.3s;
    }
    .cp-header .cp-arrow {
      font-size: 12px;
      color: var(--text-light);
      transition: transform 0.2s;
    }
    .cp-header.expanded .cp-arrow { transform: rotate(90deg); }
    .cp-tasks { display: none; }
    .cp-tasks.show { display: block; }
    .cp-task-item {
      padding: 10px 16px 10px 28px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .cp-task-item:active { background: #f5f5f5; }
    .cp-task-item:last-child { border-bottom: none; }
    .cp-task-item .task-info { flex: 1; }
    .cp-task-item .task-info .task-time-row {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="mobile-page">
    <div class="mobile-header">
      <h1>我的任务</h1>
      <div class="header-right" id="headerUser"></div>
    </div>

    <div class="tab-bar">
      <div class="tab active" data-status="" onclick="switchTab(this)">待检查</div>
      <div class="tab" data-status="completed" onclick="switchTab(this)">已完成</div>
    </div>

    <div class="task-list" id="taskList"></div>
  </div>

  <nav class="bottom-nav">
    <a href="/mobile/tasks.html" class="active">
      <span class="nav-icon">&#9745;</span>
      <span>任务</span>
    </a>
    <a href="/mobile/profile.html">
      <span class="nav-icon">&#9786;</span>
      <span>我的</span>
    </a>
  </nav>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/utils.js"></script>
  <script>
    if (!AUTH.requireAuth(['staff', 'admin', 'super_admin'])) throw new Error('no auth');

    var currentStatus = '';
    var user = AUTH.getUser();
    document.getElementById('headerUser').textContent = user.realName;

    Utils.showLoading('加载任务...');
    loadTasks();
    setInterval(loadTasks, 60000);

    function switchTab(el) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      el.classList.add('active');
      currentStatus = el.getAttribute('data-status');
      loadTasks();
    }

    async function loadTasks() {
      var url = '/tasks/grouped';
      if (currentStatus) url += '?status=' + currentStatus;

      try {
        var data = await API.get(url);
        renderGrouped(data.groups, data.totalTasks);
      } catch (err) {
        Utils.showToast(err.message, 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    function renderGrouped(groups, totalTasks) {
      var container = document.getElementById('taskList');
      if (!groups || groups.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="icon">&#128203;</div><div>暂无任务</div></div>';
        return;
      }

      var html = '';
      groups.forEach(function(area) {
        html += '<div class="area-group">';
        html += '<div class="area-header">' + area.areaName;
        if (area.floor || area.building) {
          html += ' <span class="floor-info">';
          if (area.building) html += area.building;
          if (area.floor) html += ' ' + area.floor;
          html += '</span>';
        }
        html += '</div>';

        area.checkpoints.forEach(function(cp) {
          var pct = cp.totalCount > 0 ? Math.round(cp.completedCount / cp.totalCount * 100) : 0;
          html += '<div class="cp-group">';
          html += '<div class="cp-header" onclick="toggleCp(this)">' +
            '<span class="cp-name">' + cp.checkpointName + '</span>' +
            '<span class="cp-progress">' +
              '<span>' + cp.completedCount + '/' + cp.totalCount + '</span>' +
              '<span class="progress-mini"><span class="progress-mini-fill" style="width:' + pct + '%"></span></span>' +
              '<span class="cp-arrow">&#9654;</span>' +
            '</span>' +
          '</div>';
          html += '<div class="cp-tasks">';
          cp.tasks.forEach(function(task) {
            html += '<div class="cp-task-item" onclick="openTask(' + task.id + ', \'' + task.status + '\')">' +
              '<div class="task-info">' +
                '<div class="task-time-row">' +
                  task.due_time.slice(5, 10) + ' ' + Utils.formatTime(task.due_time) +
                  ' | 窗口: ' + Utils.formatTime(task.window_start) + '-' + Utils.formatTime(task.window_end) +
                '</div>' +
              '</div>' +
              '<span class="badge badge-' + task.status + '">' + Utils.statusText(task.status) + '</span>' +
            '</div>';
          });
          html += '</div></div>';
        });

        html += '</div>';
      });
      container.innerHTML = html;
    }

    function toggleCp(header) {
      var tasks = header.nextElementSibling;
      var isExpanded = tasks.classList.contains('show');
      if (isExpanded) {
        tasks.classList.remove('show');
        header.classList.remove('expanded');
      } else {
        tasks.classList.add('show');
        header.classList.add('expanded');
      }
    }

    function openTask(taskId, status) {
      if (status === 'pending') {
        location.href = '/mobile/inspect.html?taskId=' + taskId;
      } else {
        Utils.showToast('该任务' + Utils.statusText(status));
      }
    }
  </script>
</body>
</html>
