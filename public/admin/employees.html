<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>员工管理 - 管理后台</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="admin-layout">
    <div class="admin-content">
      <div class="page-header">
        <h2>员工管理</h2>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>员工列表</h3>
          <button class="btn btn-primary" onclick="openCreate()">+ 添加员工</button>
        </div>
        <div class="card-body no-padding">
          <table class="data-table">
            <thead>
              <tr><th>ID</th><th>用户名</th><th>姓名</th><th>角色</th><th>手机</th><th>状态</th><th>创建时间</th><th>操作</th></tr>
            </thead>
            <tbody id="usersBody"></tbody>
          </table>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-overlay" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">添加员工</h3>
        <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="form-group">
          <label>用户名 <span class="required">*</span></label>
          <input type="text" class="form-input" id="formUsername" placeholder="用于登录">
        </div>
        <div class="form-group" id="passwordGroup">
          <label>密码 <span class="required">*</span></label>
          <input type="password" class="form-input" id="formPassword" placeholder="至少6位">
        </div>
        <div class="form-group">
          <label>姓名 <span class="required">*</span></label>
          <input type="text" class="form-input" id="formRealName" placeholder="真实姓名">
        </div>
        <div class="form-group">
          <label>手机号</label>
          <input type="tel" class="form-input" id="formPhone" placeholder="选填">
        </div>
        <div class="form-group" id="roleGroup">
          <label>角色 <span class="required">*</span></label>
          <select class="form-select" id="formRole">
            <option value="staff">接待员</option>
            <option value="admin">管理员</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="closeModal('userModal')">取消</button>
        <button class="btn btn-primary" onclick="saveUser()">保存</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h3>确认删除</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="deleteMsg" style="color:var(--danger);"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="closeModal('deleteModal')">取消</button>
        <button class="btn btn-danger" id="deleteConfirmBtn">确认删除</button>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/admin/layout.js"></script>
  <script>
    initAdminLayout('employees');
    var currentUser = AUTH.getUser();
    var isSuperAdmin = currentUser.role === 'super_admin';
    // Only super_admin can create admins
    if (!isSuperAdmin) {
      document.getElementById('roleGroup').style.display = 'none';
    }
    Utils.showLoading('加载中...');
    loadUsers();

    async function loadUsers(page) {
      page = page || 1;
      try {
        var data = await API.get('/users?page=' + page + '&limit=20');
        var roleMap = { staff: '接待员', admin: '管理员', super_admin: '超级管理员' };
        var tbody = document.getElementById('usersBody');
        if (!data.rows || data.rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-light)">暂无员工</td></tr>';
        } else {
          tbody.innerHTML = data.rows.map(function(u) {
            var statusBadge = u.status === 1
              ? '<span class="badge badge-completed">启用</span>'
              : '<span class="badge badge-overdue">停用</span>';
            var deleteBtn = (isSuperAdmin && u.role !== 'super_admin')
              ? '<button class="btn btn-small btn-danger" onclick="confirmDelete(' + u.id + ',\'' + u.real_name.replace(/'/g, "\\'") + '\')">删除</button>'
              : '';
            return '<tr>' +
              '<td>' + u.id + '</td>' +
              '<td>' + u.username + '</td>' +
              '<td>' + u.real_name + '</td>' +
              '<td>' + (roleMap[u.role]||u.role) + '</td>' +
              '<td>' + (u.phone||'-') + '</td>' +
              '<td>' + statusBadge + '</td>' +
              '<td>' + u.created_at + '</td>' +
              '<td class="actions">' +
                '<button class="btn btn-small btn-default" onclick="openEdit(' + u.id + ')">编辑</button>' +
                '<button class="btn btn-small btn-default" onclick="resetPassword(' + u.id + ')">重置密码</button>' +
                '<button class="btn btn-small ' + (u.status===1?'btn-danger':'btn-success') + '" onclick="toggleStatus(' + u.id + ')">' + (u.status===1?'停用':'启用') + '</button>' +
                deleteBtn +
              '</td>' +
            '</tr>';
          }).join('');
        }
        var total = data.total, limit = data.limit, pages = Math.ceil(total/limit);
        var pHtml = '<span class="page-info">共 ' + total + ' 条</span>';
        if (page > 1) pHtml += '<button class="btn btn-small btn-default" onclick="loadUsers(' + (page-1) + ')">上一页</button>';
        pHtml += '<span class="page-info">' + page + '/' + pages + '</span>';
        if (page < pages) pHtml += '<button class="btn btn-small btn-default" onclick="loadUsers(' + (page+1) + ')">下一页</button>';
        document.getElementById('pagination').innerHTML = pHtml;
      } catch (err) {
        Utils.showToast(err.message, 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    function openCreate() {
      document.getElementById('modalTitle').textContent = '添加员工';
      document.getElementById('editId').value = '';
      document.getElementById('formUsername').value = '';
      document.getElementById('formUsername').disabled = false;
      document.getElementById('formPassword').value = '';
      document.getElementById('passwordGroup').style.display = '';
      document.getElementById('formRealName').value = '';
      document.getElementById('formPhone').value = '';
      document.getElementById('formRole').value = 'staff';
      document.getElementById('userModal').classList.add('show');
    }

    async function openEdit(id) {
      try {
        var user = await API.get('/users/' + id);
        document.getElementById('modalTitle').textContent = '编辑员工';
        document.getElementById('editId').value = id;
        document.getElementById('formUsername').value = user.username;
        document.getElementById('formUsername').disabled = true;
        document.getElementById('passwordGroup').style.display = 'none';
        document.getElementById('formRealName').value = user.real_name;
        document.getElementById('formPhone').value = user.phone || '';
        document.getElementById('formRole').value = user.role;
        document.getElementById('userModal').classList.add('show');
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    async function saveUser() {
      var editId = document.getElementById('editId').value;
      var data = {
        realName: document.getElementById('formRealName').value.trim(),
        phone: document.getElementById('formPhone').value.trim(),
        role: document.getElementById('formRole').value,
      };

      if (!data.realName) {
        Utils.showToast('请输入姓名', 'warning');
        return;
      }

      if (!editId) {
        data.username = document.getElementById('formUsername').value.trim();
        data.password = document.getElementById('formPassword').value;
        if (!data.username) { Utils.showToast('请输入用户名', 'warning'); return; }
        if (!data.password || data.password.length < 6) { Utils.showToast('密码至少6位', 'warning'); return; }
      }

      var btn = event.target;
      if (!Utils.btnLoading(btn, '保存中...')) return;

      try {
        if (editId) { await API.put('/users/' + editId, data); }
        else { await API.post('/users', data); }
        Utils.btnReset(btn);
        closeModal('userModal');
        Utils.showToast('保存成功', 'success');
        loadUsers();
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    async function resetPassword(id) {
      var pwd = prompt('请输入新密码（至少6位）:');
      if (!pwd) return;
      if (pwd.length < 6) { Utils.showToast('密码至少6位', 'warning'); return; }
      try {
        await API.put('/users/' + id + '/password', { password: pwd });
        Utils.showToast('密码已重置', 'success');
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    async function toggleStatus(id) {
      try {
        var result = await API.put('/users/' + id + '/status');
        Utils.showToast(result.message, 'success');
        loadUsers();
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    async function confirmDelete(id, name) {
      try {
        var countData = await API.get('/users/' + id + '/record-count');
        var count = countData.count || 0;
        var msg = count > 0
          ? '该员工"' + name + '"有 ' + count + ' 条巡检记录，删除后记录将保留但显示"已删除员工"。确认删除？'
          : '确定要删除员工"' + name + '"吗？此操作不可撤销。';
        document.getElementById('deleteMsg').textContent = msg;
        document.getElementById('deleteConfirmBtn').onclick = function() { deleteUser(id); };
        document.getElementById('deleteModal').classList.add('show');
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    async function deleteUser(id) {
      var btn = document.getElementById('deleteConfirmBtn');
      if (!Utils.btnLoading(btn, '删除中...')) return;
      try {
        var result = await API.del('/users/' + id);
        Utils.btnReset(btn);
        Utils.showToast(result.message, 'success');
        closeModal('deleteModal');
        loadUsers();
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }
  </script>
</body>
</html>
