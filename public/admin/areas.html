<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>区域管理 - 管理后台</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="admin-layout">
    <div class="admin-content">
      <div class="page-header"><h2>区域与检查点管理</h2></div>

      <div class="two-panel">
        <!-- Left: Areas -->
        <div class="card">
          <div class="card-header">
            <h3>区域列表</h3>
            <button class="btn btn-small btn-primary" onclick="openCreateArea()">+ 添加</button>
          </div>
          <div class="card-body no-padding">
            <div class="panel-list" id="areaList"></div>
          </div>
        </div>

        <!-- Right: Checkpoints -->
        <div class="card">
          <div class="card-header">
            <h3 id="cpTitle">选择一个区域查看检查点</h3>
            <button class="btn btn-small btn-primary" id="addCpBtn" onclick="openCreateCheckpoint()" style="display:none;">+ 添加检查点</button>
          </div>
          <div class="card-body no-padding">
            <table class="data-table" id="cpTable" style="display:none;">
              <thead><tr><th>排序</th><th>名称</th><th>描述</th><th>状态</th><th>操作</th></tr></thead>
              <tbody id="cpBody"></tbody>
            </table>
            <div id="cpEmpty" class="empty-state">请从左侧选择一个区域</div>
          </div>
          <!-- Inspect Items Section -->
          <div id="inspectItemsSection" style="display:none; border-top:1px solid var(--border); padding:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h4 style="font-size:14px; font-weight:600;">检查项目配置</h4>
              <button class="btn btn-small btn-default" onclick="openCreateItem()">+ 新建检查项</button>
            </div>
            <div id="inspectItemsList"></div>
            <div style="margin-top:12px;">
              <button class="btn btn-primary btn-small" onclick="saveAreaItems()">保存检查项配置</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Area Modal -->
  <div class="modal-overlay" id="areaModal">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 id="areaModalTitle">添加区域</h3>
        <button class="modal-close" onclick="closeModal('areaModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="areaEditId">
        <div class="form-group">
          <label>区域名称 <span class="required">*</span></label>
          <input type="text" class="form-input" id="areaName" placeholder="如：1楼男厕">
        </div>
        <div class="form-group">
          <label>楼层</label>
          <input type="text" class="form-input" id="areaFloor" placeholder="如：1F">
        </div>
        <div class="form-group">
          <label>建筑</label>
          <input type="text" class="form-input" id="areaBuilding" placeholder="如：主楼">
        </div>
        <div class="form-group">
          <label>描述</label>
          <textarea class="form-textarea" id="areaDesc" rows="2" placeholder="选填"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="closeModal('areaModal')">取消</button>
        <button class="btn btn-primary" onclick="saveArea()">保存</button>
      </div>
    </div>
  </div>

  <!-- Checkpoint Modal -->
  <div class="modal-overlay" id="cpModal">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 id="cpModalTitle">添加检查点</h3>
        <button class="modal-close" onclick="closeModal('cpModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cpEditId">
        <div class="form-group">
          <label>检查点名称 <span class="required">*</span></label>
          <input type="text" class="form-input" id="cpName" placeholder="如：1号坑位">
        </div>
        <div class="form-group">
          <label>描述</label>
          <textarea class="form-textarea" id="cpDesc" rows="2" placeholder="选填"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="closeModal('cpModal')">取消</button>
        <button class="btn btn-primary" onclick="saveCheckpoint()">保存</button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <h3>确认删除</h3>
        <button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmMsg" style="color:var(--danger);"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="closeModal('confirmModal')">取消</button>
        <button class="btn btn-danger" id="confirmBtn">确认删除</button>
      </div>
    </div>
  </div>

  <!-- Inspect Item Modal -->
  <div class="modal-overlay" id="itemModal">
    <div class="modal" style="max-width:450px;">
      <div class="modal-header">
        <h3 id="itemModalTitle">新建检查项</h3>
        <button class="modal-close" onclick="closeModal('itemModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="itemEditId">
        <div class="form-group">
          <label>项目标识 <span class="required">*</span></label>
          <input type="text" class="form-input" id="itemKey" placeholder="英文标识，如: mirror_clean">
        </div>
        <div class="form-group">
          <label>项目名称 <span class="required">*</span></label>
          <input type="text" class="form-input" id="itemName" placeholder="如: 镜面是否清洁">
        </div>
        <div class="form-group">
          <label>类型 <span class="required">*</span></label>
          <select class="form-select" id="itemType" onchange="toggleOptionsInput()">
            <option value="radio">单选</option>
            <option value="text">文本</option>
          </select>
        </div>
        <div class="form-group" id="optionsGroup">
          <label>选项（逗号分隔） <span class="required">*</span></label>
          <input type="text" class="form-input" id="itemOptions" placeholder="如: 清洁,脏污">
        </div>
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="itemRequired" checked> 必填
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" onclick="closeModal('itemModal')">取消</button>
        <button class="btn btn-primary" onclick="saveItem()">保存</button>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/admin/layout.js"></script>
  <script>
    initAdminLayout('areas');
    var selectedAreaId = null;
    var user = AUTH.getUser();
    var isSuperAdmin = user.role === 'super_admin';
    Utils.showLoading('加载中...');
    loadAreas();

    async function loadAreas() {
      try {
        var areas = await API.get('/areas');
        var html = '';
        if (areas.length === 0) {
          html = '<div class="empty-state">暂无区域</div>';
        } else {
          areas.forEach(function(a) {
            var cls = a.id === selectedAreaId ? 'panel-list-item active' : 'panel-list-item';
            var deleteLink = isSuperAdmin ? ' | <a href="#" onclick="event.stopPropagation();confirmDeleteArea(' + a.id + ',\'' + a.name.replace(/'/g,"\\'") + '\')" style="color:var(--danger)">删除</a>' : '';
            html += '<div class="' + cls + '" onclick="selectArea(' + a.id + ')">' +
              '<div class="item-name">' + a.name + '</div>' +
              '<div class="item-sub">' + (a.building||'') + ' ' + (a.floor||'') + ' | 检查点: ' + (a.checkpoint_count||0) +
              ' | <a href="#" onclick="event.stopPropagation();openEditArea(' + a.id + ')">编辑</a>' +
              ' | <a href="#" onclick="event.stopPropagation();toggleAreaStatus(' + a.id + ')" style="color:' + (a.status===1?'var(--danger)':'var(--success)') + '">' + (a.status===1?'停用':'启用') + '</a>' +
              deleteLink +
              '</div></div>';
          });
        }
        document.getElementById('areaList').innerHTML = html;
      } catch (err) {
        Utils.showToast(err.message, 'error');
      } finally {
        Utils.hideLoading();
      }
    }

    async function selectArea(id) {
      selectedAreaId = id;
      loadAreas();
      document.getElementById('addCpBtn').style.display = '';
      document.getElementById('cpTable').style.display = '';
      document.getElementById('cpEmpty').style.display = 'none';

      try {
        var area = await API.get('/areas/' + id);
        document.getElementById('cpTitle').textContent = area.name + ' - 检查点';
        var cps = area.checkpoints || [];
        var tbody = document.getElementById('cpBody');
        if (cps.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-light)">暂无检查点</td></tr>';
        } else {
          tbody.innerHTML = cps.map(function(c) {
            var statusBadge = c.status === 1 ? '<span class="badge badge-completed">启用</span>' : '<span class="badge badge-overdue">停用</span>';
            var deleteBtn = isSuperAdmin ? '<button class="btn btn-small btn-danger" onclick="confirmDeleteCp(' + c.id + ',\'' + c.name.replace(/'/g,"\\'") + '\')">删除</button>' : '';
            return '<tr><td>' + c.sort_order + '</td><td>' + c.name + '</td><td>' + (c.description||'-') + '</td><td>' + statusBadge + '</td>' +
              '<td class="actions">' +
                '<button class="btn btn-small btn-default" onclick="openEditCp(' + c.id + ',\'' + c.name.replace(/'/g,"\\'") + '\',\'' + (c.description||'').replace(/'/g,"\\'") + '\')">编辑</button>' +
                '<button class="btn btn-small ' + (c.status===1?'btn-danger':'btn-success') + '" onclick="toggleCpStatus(' + c.id + ')">' + (c.status===1?'停用':'启用') + '</button>' +
                deleteBtn +
              '</td></tr>';
          }).join('');
        }
        loadAreaInspectItems(id);
        document.getElementById('inspectItemsSection').style.display = '';
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    function openCreateArea() {
      document.getElementById('areaModalTitle').textContent = '添加区域';
      document.getElementById('areaEditId').value = '';
      document.getElementById('areaName').value = '';
      document.getElementById('areaFloor').value = '';
      document.getElementById('areaBuilding').value = '';
      document.getElementById('areaDesc').value = '';
      document.getElementById('areaModal').classList.add('show');
    }

    async function openEditArea(id) {
      try {
        var a = await API.get('/areas/' + id);
        document.getElementById('areaModalTitle').textContent = '编辑区域';
        document.getElementById('areaEditId').value = id;
        document.getElementById('areaName').value = a.name;
        document.getElementById('areaFloor').value = a.floor || '';
        document.getElementById('areaBuilding').value = a.building || '';
        document.getElementById('areaDesc').value = a.description || '';
        document.getElementById('areaModal').classList.add('show');
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    async function saveArea() {
      var name = document.getElementById('areaName').value.trim();
      if (!name) { Utils.showToast('请输入区域名称', 'warning'); return; }
      var data = {
        name: name,
        floor: document.getElementById('areaFloor').value.trim(),
        building: document.getElementById('areaBuilding').value.trim(),
        description: document.getElementById('areaDesc').value.trim(),
      };
      var editId = document.getElementById('areaEditId').value;
      var btn = event.target;
      if (!Utils.btnLoading(btn, '保存中...')) return;
      try {
        if (editId) { await API.put('/areas/' + editId, data); }
        else { await API.post('/areas', data); }
        Utils.btnReset(btn);
        closeModal('areaModal');
        Utils.showToast('保存成功', 'success');
        loadAreas();
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    async function toggleAreaStatus(id) {
      try {
        var result = await API.put('/areas/' + id + '/status');
        Utils.showToast(result.message, 'success');
        loadAreas();
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    function confirmDeleteArea(id, name) {
      document.getElementById('confirmMsg').textContent = '确定要删除区域"' + name + '"吗？将同时删除其下所有检查点、排班和任务。此操作不可撤销。';
      document.getElementById('confirmBtn').onclick = function() { deleteArea(id); };
      document.getElementById('confirmModal').classList.add('show');
    }

    async function deleteArea(id) {
      var btn = document.getElementById('confirmBtn');
      if (!Utils.btnLoading(btn, '删除中...')) return;
      try {
        var result = await API.del('/areas/' + id);
        Utils.btnReset(btn);
        Utils.showToast(result.message, 'success');
        closeModal('confirmModal');
        selectedAreaId = null;
        document.getElementById('cpTable').style.display = 'none';
        document.getElementById('cpEmpty').style.display = '';
        document.getElementById('cpTitle').textContent = '选择一个区域查看检查点';
        document.getElementById('addCpBtn').style.display = 'none';
        document.getElementById('inspectItemsSection').style.display = 'none';
        loadAreas();
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    function openCreateCheckpoint() {
      document.getElementById('cpModalTitle').textContent = '添加检查点';
      document.getElementById('cpEditId').value = '';
      document.getElementById('cpName').value = '';
      document.getElementById('cpDesc').value = '';
      document.getElementById('cpModal').classList.add('show');
    }

    function openEditCp(id, name, desc) {
      document.getElementById('cpModalTitle').textContent = '编辑检查点';
      document.getElementById('cpEditId').value = id;
      document.getElementById('cpName').value = name;
      document.getElementById('cpDesc').value = desc;
      document.getElementById('cpModal').classList.add('show');
    }

    async function saveCheckpoint() {
      var name = document.getElementById('cpName').value.trim();
      if (!name) { Utils.showToast('请输入检查点名称', 'warning'); return; }
      var data = { name: name, description: document.getElementById('cpDesc').value.trim() };
      var editId = document.getElementById('cpEditId').value;
      var btn = event.target;
      if (!Utils.btnLoading(btn, '保存中...')) return;
      try {
        if (editId) { await API.put('/checkpoints/' + editId, data); }
        else { await API.post('/areas/' + selectedAreaId + '/checkpoints', data); }
        Utils.btnReset(btn);
        closeModal('cpModal');
        Utils.showToast('保存成功', 'success');
        selectArea(selectedAreaId);
        loadAreas();
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    async function toggleCpStatus(id) {
      try {
        var result = await API.put('/checkpoints/' + id + '/status');
        Utils.showToast(result.message, 'success');
        selectArea(selectedAreaId);
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    function confirmDeleteCp(id, name) {
      document.getElementById('confirmMsg').textContent = '确定要删除检查点"' + name + '"吗？将同时删除其相关排班和任务。此操作不可撤销。';
      document.getElementById('confirmBtn').onclick = function() { deleteCp(id); };
      document.getElementById('confirmModal').classList.add('show');
    }

    async function deleteCp(id) {
      var btn = document.getElementById('confirmBtn');
      if (!Utils.btnLoading(btn, '删除中...')) return;
      try {
        var result = await API.del('/areas/' + selectedAreaId + '/checkpoints/' + id);
        Utils.btnReset(btn);
        Utils.showToast(result.message, 'success');
        closeModal('confirmModal');
        selectArea(selectedAreaId);
        loadAreas();
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    // --- Inspect Items Management ---

    async function loadAreaInspectItems(areaId) {
      try {
        var items = await API.get('/areas/' + areaId + '/inspect-items');
        var html = '';
        items.forEach(function(item) {
          var checked = item.enabled ? 'checked' : '';
          var typeLabel = item.input_type === 'radio' ? '单选: ' + (item.options || []).join('/') : '文本输入';
          var requiredLabel = item.required ? ' <span style="color:var(--danger);font-size:11px;">*必填</span>' : '';
          var defaultTag = item.is_default ? ' <span style="background:#e6f7ff;color:var(--primary);padding:1px 6px;border-radius:8px;font-size:11px;">默认</span>' : '';
          html += '<label style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;">' +
            '<input type="checkbox" class="area-item-cb" value="' + item.id + '" ' + checked + '>' +
            '<span style="flex:1;">' + item.item_name + requiredLabel + defaultTag + '</span>' +
            '<span style="font-size:12px;color:var(--text-light);white-space:nowrap;">' + typeLabel + '</span>' +
          '</label>';
        });
        document.getElementById('inspectItemsList').innerHTML = html || '<div class="empty-state" style="padding:16px 0;">暂无检查项</div>';
      } catch (err) {
        Utils.showToast(err.message, 'error');
      }
    }

    async function saveAreaItems() {
      var checkboxes = document.querySelectorAll('.area-item-cb');
      var itemIds = [];
      checkboxes.forEach(function(cb) {
        if (cb.checked) itemIds.push(parseInt(cb.value));
      });
      var btn = event.target;
      if (!Utils.btnLoading(btn, '保存中...')) return;
      try {
        await API.put('/areas/' + selectedAreaId + '/inspect-items', { itemIds: itemIds });
        Utils.btnReset(btn);
        Utils.showToast('检查项配置已保存', 'success');
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    function toggleOptionsInput() {
      document.getElementById('optionsGroup').style.display =
        document.getElementById('itemType').value === 'radio' ? '' : 'none';
    }

    function openCreateItem() {
      document.getElementById('itemModalTitle').textContent = '新建检查项';
      document.getElementById('itemEditId').value = '';
      document.getElementById('itemKey').value = '';
      document.getElementById('itemKey').disabled = false;
      document.getElementById('itemName').value = '';
      document.getElementById('itemType').value = 'radio';
      document.getElementById('itemOptions').value = '';
      document.getElementById('itemRequired').checked = true;
      document.getElementById('optionsGroup').style.display = '';
      document.getElementById('itemModal').classList.add('show');
    }

    async function saveItem() {
      var editId = document.getElementById('itemEditId').value;
      var name = document.getElementById('itemName').value.trim();
      var type = document.getElementById('itemType').value;
      var required = document.getElementById('itemRequired').checked;

      if (!name) { Utils.showToast('请输入项目名称', 'warning'); return; }

      var options = null;
      if (type === 'radio') {
        var optStr = document.getElementById('itemOptions').value.trim();
        options = optStr.split(/[,，]/).map(function(s) { return s.trim(); }).filter(Boolean);
        if (options.length < 2) { Utils.showToast('单选项至少需要2个选项', 'warning'); return; }
      }

      var btn = event.target;
      if (!Utils.btnLoading(btn, '保存中...')) return;

      try {
        if (editId) {
          await API.put('/inspect-items/' + editId, { itemName: name, inputType: type, options: options, required: required });
        } else {
          var key = document.getElementById('itemKey').value.trim();
          if (!key) { Utils.btnReset(btn); Utils.showToast('请输入项目标识', 'warning'); return; }
          await API.post('/inspect-items', { itemKey: key, itemName: name, inputType: type, options: options, required: required });
        }
        Utils.btnReset(btn);
        closeModal('itemModal');
        Utils.showToast('保存成功', 'success');
        if (selectedAreaId) loadAreaInspectItems(selectedAreaId);
      } catch (err) {
        Utils.btnReset(btn);
        Utils.showToast(err.message, 'error');
      }
    }

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
  </script>
</body>
</html>
